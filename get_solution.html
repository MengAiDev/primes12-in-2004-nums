<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿ç»­2004ä¸ªæ•°ä¸­æ°å¥½12ä¸ªè´¨æ•°</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: linear-gradient(145deg, #f0f4fa 0%, #dae5f0 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }
        .card {
            max-width: 1300px;
            width: 100%;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 48px;
            box-shadow: 0 25px 50px -10px rgba(0,20,40,0.3), inset 0 1px 2px rgba(255,255,255,0.6);
            padding: 28px 32px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        h1 {
            font-size: 2.1rem;
            font-weight: 600;
            margin: 0 0 6px 0;
            background: linear-gradient(135deg, #0b2b44, #2a5f7a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1 span {
            background: #1e3b4f;
            color: white;
            font-size: 1rem;
            padding: 6px 16px;
            border-radius: 40px;
            background: linear-gradient(145deg, #2f4b62, #17323f);
            box-shadow: inset 0 2px 3px rgba(255,255,255,0.3), 0 4px 8px rgba(0,10,20,0.3);
            -webkit-text-fill-color: white;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        .subtitle {
            color: #1f4662;
            margin-top: 0;
            margin-bottom: 28px;
            font-size: 1.1rem;
            border-left: 4px solid #3f7e9e;
            padding-left: 18px;
            background: rgba(60, 110, 140, 0.05);
            border-radius: 0 20px 20px 0;
        }
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 14px 20px;
            align-items: flex-end;
            margin-bottom: 28px;
            background: rgba(255,255,255,0.3);
            padding: 22px 22px 18px 22px;
            border-radius: 42px;
            backdrop-filter: blur(4px);
            box-shadow: 0 6px 14px rgba(35, 55, 80, 0.1);
        }
        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 260px;
            flex: 2 1 300px;
        }
        .input-group label {
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #0e3a4f;
            margin-bottom: 5px;
        }
        .input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .input-row input {
            flex: 1;
            background: white;
            border: 2px solid #cbdbe9;
            border-radius: 60px;
            padding: 14px 20px;
            font-size: 1rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            outline: none;
            transition: 0.15s;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
        }
        .input-row input:focus {
            border-color: #2f7ca0;
            box-shadow: 0 0 0 4px rgba(47,124,160,0.15);
        }
        .exp-slider {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #e3edf5;
            padding: 5px 18px;
            border-radius: 40px;
            border: 1px solid #b5cfdf;
        }
        .exp-slider span {
            font-weight: 700;
            color: #134257;
            font-size: 1.2rem;
        }
        button {
            background: #245e7c;
            border: none;
            border-radius: 60px;
            padding: 14px 28px;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 10px 18px -8px #1f4a63, 0 2px 0 0 #c2e0f0 inset;
            transition: 0.1s ease;
            border: 1px solid rgba(255,255,255,0.3);
            min-width: 130px;
        }
        button:hover {
            background: #2b6f92;
            transform: translateY(-3px);
            box-shadow: 0 18px 25px -10px #1f4a63, 0 2px 0 0 #daf2ff inset;
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 5px 12px -6px #0f2f40;
        }
        button.outline {
            background: rgba(255,255,255,0.6);
            color: #0a3142;
            box-shadow: 0 0 0 2px #7ba1b9 inset;
            backdrop-filter: blur(4px);
        }
        button.outline:hover {
            background: white;
        }
        .stats {
            background: #ddeeff;
            border-radius: 48px;
            padding: 22px 28px;
            margin-bottom: 26px;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 28px 48px;
            border: 1px solid white;
        }
        .stat-item {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        .stat-label {
            font-size: 1rem;
            font-weight: 500;
            color: #1c4b64;
        }
        .stat-value {
            font-size: 2.3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: #0a2a3a;
            color: white;
            padding: 6px 24px;
            border-radius: 80px;
            letter-spacing: 1px;
            box-shadow: inset 0 2px 5px #adcfdf, 0 5px 0 #08212e;
        }
        .badge {
            background: #d2e2f0;
            border-radius: 30px;
            padding: 8px 22px;
            font-size: 1.2rem;
            font-weight: 500;
            color: #103d54;
            transition: 0.2s;
        }
        .badge.hit {
            background: #f7d44a;
            color: #1d3b4f;
            font-weight: 700;
            box-shadow: 0 0 0 3px #ffec9e;
        }
        .full-number-area {
            margin-top: 12px;
            background: #eaf3fc;
            border-radius: 30px;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #b2cfec;
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
        }
        .full-number-label {
            font-weight: 600;
            color: #0d405a;
            white-space: nowrap;
        }
        .full-number-value {
            font-size: 0.95rem;
            background: white;
            padding: 8px 18px;
            border-radius: 60px;
            border: 1px solid #aac3db;
            flex: 1;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
        }
        .copy-btn {
            background: #2b5e7c;
            border-radius: 40px;
            padding: 8px 20px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            white-space: nowrap;
            box-shadow: 0 4px 6px #0d3142;
        }
        .copy-btn:hover {
            background: #3f7a9c;
        }
        .visual-container {
            background: #192f3c;
            border-radius: 36px;
            padding: 30px 20px 20px 20px;
            box-shadow: inset 0 0 0 1px #698fa8, 0 20px 30px -10px black;
        }
        .canvas-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: 22px;
            background: #0f1f28;
            padding: 8px 0;
            box-shadow: inset 0 2px 10px #030a0f;
        }
        canvas {
            display: block;
            height: 50px;
            width: 2004px;
            image-rendering: crisp-edges;
            background: #1b3341;
            border-radius: 8px;
        }
        .legend {
            display: flex;
            gap: 30px;
            justify-content: flex-end;
            margin-top: 18px;
            color: #c1d9e8;
            font-size: 0.95rem;
        }
        .legend span::before {
            content: "â¬¤";
            margin-right: 8px;
            font-size: 1.4rem;
            vertical-align: middle;
            display: inline-block;
        }
        .prime-legend::before { color: #ffaa5e; }
        .composite-legend::before { color: #507e9c; }
        footer {
            text-align: center;
            margin-top: 24px;
            color: #2f5875;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="card">
    <h1>
        2004 è¿å·
        <span>æ°å¥½ 12 ä¸ªè´¨æ•°</span>
    </h1>
    <div class="subtitle">
        åœ¨å·¨å¤§çš„è‡ªç„¶æ•°é¢†åŸŸ (â‰ˆ10â·Â²) ï¼Œè¿ç»­2004ä¸ªæ•°ä¸­å¹³å‡åªå‡ºç°12ä¸ªè´¨æ•°ã€‚é€šè¿‡éšæœºé‡‡æ ·æ‰¾å‡ºè¿™æ ·ç¨€æœ‰çš„åŒºé—´ã€‚
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label> èµ·å§‹æ•° (è¶…å¤§æ•´æ•°)</label>
            <div class="input-row">
                <input type="text" id="startInput" value="724648980675214569874321656789012345678901234567890123456789012345678901" placeholder="ä¾‹å¦‚ 10^72 å·¦å³çš„æ•´æ•°">
                <button class="outline" id="applyStartBtn">â†µ è®¡ç®—</button>
            </div>
        </div>
        <div class="exp-slider">
            <span>10^</span>
            <input type="range" id="expRange" min="65" max="80" value="72" step="0.5" style="width:200px">
            <span id="expDisplay">72.0</span>
        </div>
        <button id="randomStartBtn"> éšæœºèµ·ç‚¹</button>
        <button id="find12Btn"> å¯»æ‰¾12ä¸ªè´¨æ•° (éšæœºå°è¯•)</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <span class="stat-label">å½“å‰åŒºé—´è´¨æ•°ä¸ªæ•°</span>
            <span class="stat-value" id="primeCount">---</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ä¸ç›®æ ‡å·®å€¼</span>
            <span class="badge" id="diffTarget">---</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">ç§‘å­¦è®°æ•°æ³•</span>
            <span class="badge" id="startSci">---</span>
        </div>
    </div>

    <div class="full-number-area" id="fullNumberArea" style="display: none;">
        <span class="full-number-label">ç²¾ç¡®èµ·å§‹æ•°ï¼š</span>
        <span class="full-number-value" id="exactStart"></span>
        <button class="copy-btn" id="copyExactBtn">å¤åˆ¶</button>
    </div>

    <div class="visual-container">
        <div class="canvas-wrapper">
            <canvas id="primeCanvas" width="2004" height="50"></canvas>
        </div>
        <div class="legend">
            <span class="prime-legend">è´¨æ•° (æ©™)</span>
            <span class="composite-legend">åˆæ•° (è“ç°)</span>
            <span>â† 2004 ä¸ªè¿ç»­æ•´æ•° â†’ æ¯ä¸ªç«–æ¡ä»£è¡¨ä¸€ä¸ªæ•°</span>
        </div>
    </div>
    <!-- <footer>
        ä½¿ç”¨ Millerâ€“Rabin ç´ æ€§æµ‹è¯• + å°è´¨æ•°è¯•é™¤ã€‚å‘½ä¸­æ—¶ä¼šå¼¹å‡ºå®Œæ•´èµ·å§‹æ•°ï¼Œå¹¶æ˜¾ç¤ºåœ¨ä¸‹æ–¹é¢æ¿ã€‚
    </footer> -->
</div>

<script>
    (function() {
        // ---------- å·¥å…·å‡½æ•°ï¼šå¤§æ•°è¿ç®— + è´¨æ•°æµ‹è¯• ----------
        // ç”Ÿæˆå‰200ä¸ªå°è´¨æ•°ç”¨äºå¿«é€Ÿè¯•é™¤
        function generateSmallPrimes(limit = 200) {
            let primes = [];
            let isPrime = new Array(1500).fill(true);
            for (let i = 2; i < 1500; i++) {
                if (isPrime[i]) {
                    primes.push(i);
                    for (let j = i * i; j < 1500; j += i) isPrime[j] = false;
                }
            }
            return primes.slice(0, limit);
        }
        const smallPrimes = generateSmallPrimes(200).map(BigInt);

        // å¿«é€Ÿæ¨¡å¹‚ (base^exp % mod)
        function modPow(base, exp, mod) {
            if (mod === 1n) return 0n;
            let result = 1n;
            let b = base % mod;
            let e = exp;
            while (e > 0) {
                if (e & 1n) result = (result * b) % mod;
                b = (b * b) % mod;
                e >>= 1n;
            }
            return result;
        }

        // Miller-Rabin ç¡®å®šæ€§åŸºç»„ (é’ˆå¯¹ < 2^64 å…¶å®è¶³å¤Ÿï¼Œè¿™é‡Œç”¨äºè¶…å¤§æ•°çš„æ¦‚ç‡æµ‹è¯•ï¼Œå¢åŠ åŸºç»„é™ä½é”™è¯¯)
        const mrBases = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37].map(BigInt);

        function isProbablePrime(n) {
            if (n < 2n) return false;
            if (n % 2n === 0n) return n === 2n;
            // å…ˆè¯•é™¤å°è´¨æ•°
            for (let p of smallPrimes) {
                if (p >= n) break;
                if (n % p === 0n) return n === p;
            }
            // å†™ n-1 = 2^s * d
            let d = n - 1n;
            let s = 0;
            while (d % 2n === 0n) {
                d /= 2n;
                s++;
            }
            // å¯¹æ¯ä¸ªåŸºæµ‹è¯•
            testBase: for (let a of mrBases) {
                if (a >= n) continue;
                let x = modPow(a, d, n);
                if (x === 1n || x === n - 1n) continue;
                for (let r = 1; r < s; r++) {
                    x = (x * x) % n;
                    if (x === n - 1n) continue testBase;
                }
                return false; // åˆæ•°
            }
            return true; // å¯èƒ½æ˜¯ç´ æ•°
        }

        // è®¡ç®—åŒºé—´ [start, start+2003] å†…è´¨æ•°ä¸ªæ•°ï¼Œå¹¶è¿”å›æ¯ä¸ªæ•°çš„è´¨æ•°æ ‡è®°æ•°ç»„
        function scanRange(start) {
            let count = 0;
            const marks = new Array(2004).fill(false);
            for (let i = 0; i < 2004; i++) {
                let num = start + BigInt(i);
                let isPrime = isProbablePrime(num);
                marks[i] = isPrime;
                if (isPrime) count++;
            }
            return { count, marks };
        }

        // éšæœºç”ŸæˆæŒ‡å®šä½æ•°çš„å¤§æ•´æ•° (åè¿›åˆ¶)
        function randomBigIntByExponent(exp) {
            let digits = Math.floor(exp);
            if (digits < 1) digits = 1;
            let first = Math.floor(Math.random() * 9) + 1;
            let str = first.toString();
            for (let i = 1; i < digits; i++) {
                str += Math.floor(Math.random() * 10).toString();
            }
            return BigInt(str);
        }

        // å°† BigInt è½¬æ¢ä¸ºç§‘å­¦è®°æ•°æ³•å­—ç¬¦ä¸² (ä¿ç•™3ä½æœ‰æ•ˆæ•°å­—)
        function bigIntToSci(n) {
            let s = n.toString();
            if (s.length <= 1) return s;
            let first = s[0];
            if (s.length > 1) first += '.' + s.slice(1, 4);
            return first + 'e' + (s.length - 1);
        }

        // æ¸²æŸ“ canvas
        function renderMarks(marks) {
            const canvas = document.getElementById('primeCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < marks.length; i++) {
                ctx.fillStyle = marks[i] ? '#ffaa5e' : '#507e9c';
                ctx.fillRect(i, 0, 1, 50);
            }
        }

        // æ˜¾ç¤ºå®Œæ•´èµ·å§‹æ•°åŒºåŸŸå¹¶å¡«å……æ•°å­—
        function showExactStart(number) {
            const area = document.getElementById('fullNumberArea');
            const exactSpan = document.getElementById('exactStart');
            exactSpan.innerText = number.toString();
            area.style.display = 'flex';  // æ˜¾ç¤ºåŒºåŸŸ
        }

        // å¤åˆ¶åŠŸèƒ½
        document.getElementById('copyExactBtn').addEventListener('click', () => {
            const text = document.getElementById('exactStart').innerText;
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… èµ·å§‹æ•°å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
                });
            }
        });

        // ---------- é¡µé¢å…ƒç´ ç»‘å®š ----------
        const startInput = document.getElementById('startInput');
        const applyStartBtn = document.getElementById('applyStartBtn');
        const randomStartBtn = document.getElementById('randomStartBtn');
        const find12Btn = document.getElementById('find12Btn');
        const expRange = document.getElementById('expRange');
        const expDisplay = document.getElementById('expDisplay');
        const primeCountSpan = document.getElementById('primeCount');
        const diffTargetSpan = document.getElementById('diffTarget');
        const startSciSpan = document.getElementById('startSci');

        let currentStart = 724648980675214569874321656789012345678901234567890123456789012345678901n;
        let currentMarks = new Array(2004).fill(false);
        let currentCount = 0;

        function updateDisplayFromStart(start) {
            startInput.value = start.toString();
            const { count, marks } = scanRange(start);
            currentMarks = marks;
            currentCount = count;
            primeCountSpan.innerText = count;
            const diff = count - 12;
            diffTargetSpan.innerText = (diff > 0 ? '+' : '') + diff + (diff === 0 ? '  âœ¨ å‘½ä¸­ï¼' : '');
            if (diff === 0) {
                diffTargetSpan.classList.add('hit');
                // å‘½ä¸­æ—¶è‡ªåŠ¨å±•å¼€å®Œæ•´æ•°å­—åŒºåŸŸ
                showExactStart(start);
            } else {
                diffTargetSpan.classList.remove('hit');
            }
            startSciSpan.innerText = bigIntToSci(start);
            renderMarks(marks);
        }

        function getStartFromInput() {
            try {
                let raw = startInput.value.trim();
                if (raw === '') throw new Error('ç©ºè¾“å…¥');
                return BigInt(raw);
            } catch (e) {
                alert('è¾“å…¥æ— æ•ˆï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªæœ‰æ•ˆèµ·å§‹æ•°');
                return currentStart;
            }
        }

        applyStartBtn.addEventListener('click', () => {
            let start = getStartFromInput();
            currentStart = start;
            updateDisplayFromStart(start);
        });

        randomStartBtn.addEventListener('click', () => {
            let exp = parseFloat(expRange.value);
            let start = randomBigIntByExponent(exp);
            currentStart = start;
            updateDisplayFromStart(start);
        });

        // å¯»æ‰¾12ä¸ªè´¨æ•°
        let searching = false;
        find12Btn.addEventListener('click', async () => {
            if (searching) {
                searching = false;
                find12Btn.innerText = 'âœ¨ å¯»æ‰¾12ä¸ªè´¨æ•° (éšæœºå°è¯•)';
                return;
            }
            searching = true;
            find12Btn.innerText = 'â¹ï¸ åœæ­¢å¯»æ‰¾';
            let exp = parseFloat(expRange.value);
            let attempts = 0;
            while (searching) {
                attempts++;
                let candidate = randomBigIntByExponent(exp);
                await new Promise(res => setTimeout(res, 0)); // è®©å‡ºäº‹ä»¶å¾ªç¯
                const { count, marks } = scanRange(candidate);
                if (count === 12) {
                    // æ‰¾åˆ°ï¼æ›´æ–°ç•Œé¢
                    currentStart = candidate;
                    currentMarks = marks;
                    currentCount = count;
                    primeCountSpan.innerText = count;
                    diffTargetSpan.innerText = '0  âœ¨ å‘½ä¸­ï¼';
                    diffTargetSpan.classList.add('hit');
                    startSciSpan.innerText = bigIntToSci(candidate);
                    renderMarks(marks);
                    startInput.value = candidate.toString();
                    // æ˜¾ç¤ºå®Œæ•´æ•°å­—åŒºåŸŸ
                    showExactStart(candidate);
                    // å¼¹å‡ºç²¾ç¡®æ¶ˆæ¯æ¡†ï¼ˆå«å®Œæ•´æ•°å­—ï¼‰
                    alert(`ğŸ‰ æ‰¾åˆ°äº†ï¼å°è¯• ${attempts} æ¬¡åå‘½ä¸­ã€‚\n\nèµ·å§‹æ•°ï¼ˆå®Œæ•´ç²¾ç¡®ï¼‰:\n${candidate.toString()}`);
                    searching = false;
                    find12Btn.innerText = 'âœ¨ å¯»æ‰¾12ä¸ªè´¨æ•° (éšæœºå°è¯•)';
                    break;
                }
                if (attempts % 5 === 0) {
                    find12Btn.innerText = `â³ å°è¯• ${attempts} æ¬¡...`;
                }
            }
            if (!searching) {
                find12Btn.innerText = 'âœ¨ å¯»æ‰¾12ä¸ªè´¨æ•° (éšæœºå°è¯•)';
            }
        });

        // æ»‘å—æ˜¾ç¤º
        function updateExpDisplay() {
            let val = parseFloat(expRange.value).toFixed(1);
            expDisplay.innerText = val;
        }
        expRange.addEventListener('input', updateExpDisplay);
        updateExpDisplay();

        // åˆæ¬¡åŠ è½½
        window.addEventListener('load', () => {
            updateDisplayFromStart(currentStart);
        });

        // é”®ç›˜å¾®è°ƒ
        startInput.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                e.preventDefault();
                let step = e.shiftKey ? 100n : 1n;
                try {
                    let current = BigInt(startInput.value) || currentStart;
                    if (e.key === 'ArrowUp') current += step;
                    else current -= step;
                    startInput.value = current.toString();
                } catch (er) { /* ignore */ }
            }
        });
        startInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyStartBtn.click();
            }
        });

    })();
</script>
</body>
</html>
